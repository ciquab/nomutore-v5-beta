# 期間モード切替とアーカイブ挙動の調査メモ（2026-02-21）

## 1. 現行仕様の整理

### 1-1. 期間モード切替時の保存ロジック
- `PeriodService.updatePeriodSettings(newMode)` で期間モードを更新する。
- `newMode === 'permanent'` の場合、`period_archives` の各レコード内 `logs` を `logs` テーブルへ `bulkAdd` で復元し、最後に `period_archives.clear()` でアーカイブを全削除する。
- `newMode` が `weekly/monthly/custom` の場合は `PERIOD_START` を更新するのみで、アーカイブの再構築は行わない。

**結果として発生する現象**
- 週次→永久 でアーカイブは DB から消える。
- その後 永久→週次 に戻しても、消えたアーカイブを復元する処理がないため、アーカイブ一覧は空のままになる。

### 1-2. アーカイブ一覧 UI
- アーカイブ一覧は `QueryService.getArchives()` で `db.period_archives.reverse().toArray()` を描画している。
- 空配列の場合は「アーカイブはまだありません」を表示する。
- 各カードは `cursor-pointer` で見た目上タップ可能だが、`data-action` や click ハンドラが無く、タップしても何も起こらない。

### 1-3. ログ詳細表示の既存導線
- 通常ログ一覧（Cellar > Logs）では `data-log-id` をクリックすると `LogService.getById` して `openLogDetail(log)` を開く導線が既にある。
- つまり「ログ詳細モーダル自体」は既存資産があり、アーカイブ起点の導線だけ不足している。

---

## 2. 問題の本質

1) **データモデル上の破壊的変換**
- 永久モード移行時に `period_archives` を物理削除しているため、「戻したらアーカイブを再表示」の要件と構造的に衝突している。

2) **UI導線不足**
- アーカイブカードはリスト表示までで、期間内ログの詳細へドリルダウンするルートが未実装。

---

## 3. 実装方針（提案）

## 方針A（推奨）: 永久モード移行時にアーカイブを削除しない

### A-1. 仕様変更案
- `newMode === 'permanent'` でも `period_archives.clear()` を行わない。
- 必要であれば、再復元重複を避けるためアーカイブに `restoredAt` もしくは `mergedIntoLogs` フラグを持たせる（または復元自体をやめる）。

### A-2. 実装バリエーション
- **A-2-1 最小変更:**
  - 現行ロジックをほぼ維持しつつ、`clear()` を削除。
  - 追加で「同じ期間のログを再度 bulkAdd して重複しないか」のケアが必要。
- **A-2-2 より健全（推奨）:**
  - 永久モードは `QueryService.getAppDataSnapshot()` 側で「全ログを対象表示」にすでになっているため、そもそも復元処理自体を不要化する。
  - つまり永久モード移行時は `PERIOD_MODE` 更新のみ（+必要なら `PERIOD_START=0`）とし、アーカイブは参照専用で保持。

### A-3. メリット
- 週次へ戻したときにアーカイブが自然に残る（ユーザー期待に一致）。
- 破壊的なデータ消失が無くなる。
- 二重復元・重複ログ事故のリスクを下げられる。

---

## 方針B（代替）: 削除は維持しつつ「再生成」する
- 永久→週次のときに logs から期間集計を再計算して archive を再作成する方式。
- 実装コストが高く、過去期間境界の定義（月跨ぎ/カスタム境界）も再現困難なので非推奨。

---

## 4. アーカイブ詳細表示の設計案

### 4-1. 体験要件
- アーカイブ一覧のカードをタップすると「その期間の詳細」を表示。
- 期間サマリ（開始/終了、収支、ログ件数）+ 期間内ログ一覧。
- 期間内ログをさらにタップすると既存 `openLogDetail` を開く。

### 4-2. 最小実装案
1. `archiveManager.js` の各カードに `data-archive-id` を付与。
2. `document` の click 委譲で `data-archive-id` を拾う。
3. `Service.getArchives()` か `db.period_archives.get(id)` で1件取得。
4. 新規 `openArchiveDetail(archive)` モーダルを追加（`ui/logDetail.js` とは別ファイルでも可）。
5. モーダル内の各ログ行に `data-log-id` を付け、クリックで `openLogDetail(log)`。

### 4-3. 拡張実装案（将来）
- 期間比較（前期間比）
- ドライデイ率、純アルコール量など期間 KPI
- 共有画像（既存 share 機能へ連携）

---

## 5. 変更影響と注意点

1) **重複データ防止**
- 永久モード移行時の `bulkAdd` 継続案は重複混入を起こし得るため、ID除去に加えて自然キー重複チェックが必要。
- そのため「復元しない」設計への転換が安全。

2) **既存メッセージ文言**
- 設定保存時に `restoredCount` 成功メッセージを出しているため、仕様変更後は文言/条件分岐を見直す。

3) **ロールオーバー連携**
- `checkPeriodRollover()` / `archiveAndReset()` は維持し、期間完了時アーカイブ生成は現状通りで問題ない。

---

## 6. 実装ステップ案（小さく安全に）

### Step 1: 不具合修正（優先）
- 永久切替時にアーカイブを消さないよう修正。
- 可能なら復元処理自体を撤去してシンプル化。
- 設定保存メッセージ調整。

### Step 2: アーカイブ詳細導線追加
- アーカイブカード click → 詳細モーダル表示。
- 詳細内ログ click → 既存ログ詳細モーダル。

### Step 3: 受け入れ確認
- 週次→永久→週次でアーカイブが残る。
- アーカイブカードから期間詳細が開く。
- 期間詳細から個別ログ詳細が開く。
