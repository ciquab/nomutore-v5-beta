# Cellar Stats「ヘルスインサイト」改善案

## 背景（現状の論点）

- Stats タブのヘルスインサイトには「今週の純アルコール量（Weekly Alcohol）」が表示されており、ホームにも類似の Weekly Alcohol 情報があるため、情報の重複感が生まれやすい。
- デイリーチェック項目は、
  - **状態（State）**：その日の体調・結果を表す項目
  - **行動（Action）**：体調のために実行した行動を表す項目
  が混在している。
- 現在の `calcConditionScore` は boolean チェックの達成率を単一スコアに集約しているため、「状態」と「行動」を同一軸で扱ってしまい、比較や推移表示の解釈に違和感が出る。

## チェックライブラリの整理（提案）

チェックライブラリを「分析目的」で以下の 3 系統に再分類する。

### 1) 状態（State）
- 体調・主観状態の結果指標。
- 例：`waistEase`, `footLightness`, `sleepQuality`, `mood`

### 2) 行動（Action）
- その日に実行した健康行動。
- 例：`waterOk`, `fiberOk`, `supplement`, `finishTime`, `noSnack`, `vegeFirst`, `proteinOk`, `calorieLimit`, `stretch`, `stepsGoal`

### 3) トレーニング反応（Training Signal）
- 行動とも状態とも解釈が分かれやすい補助指標。
- 例：`musclePain`（「良い運動ができた」の代理で、体調そのものとは別軸で扱う）

> 実装上は、各チェック項目に `metricType: 'state' | 'action' | 'training'` を追加し、
> 後方互換のため未設定項目は `action` 扱いにする設計が安全。

## 情報設計（UI/UX）改善案


## カスタムチェック項目追加フロー（重要）

ご指摘の通り、チェック項目を再分類するなら**カスタム項目作成時に分類先選択は必須**。

### 追加UI案（カスタム項目作成モーダル）
- 項目名入力
- 説明（任意）
- **分析カテゴリ（必須）**
  - 状態（State）
  - 行動（Action）
  - トレーニング反応（Training Signal）
- （任意）飲酒日のみ項目（`drinking_only`）

### 入力補助（迷わせないためのガイド）
- 状態：その日の「結果・感覚」を記録する項目
- 行動：その日に「実施したこと」を記録する項目
- トレーニング反応：筋肉痛など、状態とも行動とも異なる補助シグナル

### デフォルト提案
- 新規カスタム項目の初期選択は `action` にする（誤分類時の影響が比較的小さいため）
- ただし未選択では保存不可（明示選択を必須化）

### 既存カスタム項目の移行方針
- 現在は未リリースかつカスタム項目未作成のため、**移行処理は不要**。
- リリース後にカスタム項目が蓄積した段階で、必要なら移行タスクを別途計画する。

### 分析の信頼性ガード
- `metricType` 未設定項目は原則発生しない前提で、保存時に必須バリデーションで防止する
- 比較表示時に「対象項目数」を表示して、スコアの解釈を補助


## A. Weekly Alcohol の重複解消

### 推奨方針（第一候補）
- Stats のヘルスインサイトから「Weekly Alcohol メーター」を外し、ホームを単一の“現在値”表示場所にする。
- Stats では「飲酒 × 体調/行動の関係分析」に集中する。

### 代替方針（残す場合）
- メーターを完全削除しない場合は、Stats 側を **分析文脈付き** に変える。
  - 例：「先週比」「28日平均比」「上限超過日数」などを追加し、ホームとの差別化を明確化する。

## B. 単一「体調%」を分解して表示

現状の「体調推移（14日間）」を、最低でも次の 2 指標に分離する。

1. **状態スコア（State Score）**
   - 分母：`metricType=state` の項目のみ
   - 解釈：その日の“コンディション結果”

2. **セルフケア実行率（Action Adherence）**
   - 分母：`metricType=action` の項目のみ
   - 解釈：その日の“実行できた行動”

（任意）3. **トレーニングシグナル**
- `training` は割合化せず、ON/OFFマーカーや別カード表示にする。

## C. 比較カードの文言変更

現行の「体調比較：飲んだ日 vs 休肝日」は以下へ置換する。

- カード1：**状態スコア比較（飲酒日 vs 休肝日）**
- カード2：**セルフケア実行率比較（飲酒日 vs 休肝日）**

これにより「飲酒日のほうが実行率は高いが、状態は低い」といった実態を分離して読める。

## D. チャート構成

- バー：純アルコール量（現状維持）
- 線1：状態スコア（state）
- 線2：セルフケア実行率（action）
- ツールチップで系列名を明示（体調%ではなく、状態/実行率として表示）

## 分析ロジック（計算）改善案

## 1) 新しいスコア計算関数

`calcConditionScore` を置き換えるのではなく、以下を追加する。

- `calcStateScore(check)`
- `calcActionScore(check, hasBeer, isDryDay)`
- `calcCompositeHealthIndex(stateScore, actionScore)`（任意。表示は補助）

ポイント：
- `drinking_only` は現行同様、休肝日は分母から除外。
- ただし `action` でのみ除外ロジックを強く効かせる。
- `state` に `drinking_only` を付与しない運用ルールを作る。

## 2) 欠損日の扱い

- 指標ごとに `null` を維持（0埋めしない）。
- チャートの `spanGaps` は線ごとに維持し、データ不足を見える化する。

## 3) サンプル数ガード

比較カード表示条件を強化：
- 各グループ（飲酒日/休肝日）で `state` が最低 3 日
- 各グループで `action` が最低 3 日

満たない場合は「サンプル不足」の説明を表示。

## 実施状況（2026-02）
- ✅ Phase1: 実装着手済み
- ✅ Phase2: 基本実装着手済み（`metricType` 付与、比較・チャート2系列化、状態/行動インサイト分離）
- ⏳ Phase3: 未着手

## 実装ステップ（段階導入）

### Phase 1（低リスク）
1. 表示文言の変更（「体調%」→「状態スコア」「セルフケア実行率」）
2. Weekly Alcohol の Stats 側表示を削除、または先週比つきに変更
3. 現行 `calcConditionScore` は残しつつ、新計算関数を追加
4. カスタム項目作成モーダルに「分析カテゴリ（必須）」を追加

### Phase 2（本命）
1. `CHECK_LIBRARY` の各項目へ `metricType` 付与
2. `renderHealthInsights` の比較・チャートを2系列化
3. テキストインサイトを「状態」と「行動」に分けて生成
4. （現時点は不要）既存カスタム項目移行は保留

### Phase 3（拡張）
1. ユーザーが表示系列を切替（状態のみ / 行動のみ / 両方）
2. 重み付けカスタマイズ（例：睡眠の重みを高くする）

## 期待できる効果

- ホームとStatsの役割分担が明確になり、重複感が減る。
- 「体調そのもの」と「体調のための行動」が分離され、ユーザーの納得感が上がる。
- 行動はできているが状態が悪い、といった改善余地を具体化できる。
